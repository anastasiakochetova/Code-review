name: Verify PR Closed and Branch Cleaned
on:
  workflow_dispatch: null
jobs:
  verify-cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check if PR was closed
        id: check_closed
        run: |
          echo "ðŸ“Œ Pull Request #${{ github.event.pull_request.number }}"
          echo "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${{ github.event.pull_request.state }}"

          if [ "${{ github.event.pull_request.state }}" == "closed" ]; then
            echo "âœ… PR ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚"
            echo "pr_closed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: PR Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚!"
            exit 1
          fi
      - name: Check if branch was deleted
        id: check_branch
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ: $BRANCH"

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ð²ÐµÑ‚ÐºÐ° Ð½Ð° origin
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð’ÐµÑ‚ÐºÐ° Ð²ÑÑ‘ ÐµÑ‰Ñ‘ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $BRANCH"
            echo "âš ï¸  Ð’ÐµÑ‚ÐºÐ° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ PR"
            exit 1
          else
            echo "âœ… Ð’ÐµÑ‚ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°: $BRANCH"
            echo "branch_deleted=true" >> $GITHUB_OUTPUT
          fi
      - name: Generate success report
        if: success()
        run: |
          python3 << 'EOF'

          pr_number = "${{ github.event.pull_request.number }}"
          branch_name = "${{ github.event.pull_request.head.ref }}"

          report = f"""# âœ… ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð£Ð¡ÐŸÐ•Ð¨ÐÐ

          ## âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PR
          - **ÐÐ¾Ð¼ÐµÑ€:** #{pr_number}
          - **Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:** âœ… Ð—ÐÐšÐ Ð«Ð¢

          ## âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð’ÐµÑ‚ÐºÐ¸
          - **Ð˜Ð¼Ñ:** {branch_name}
          - **Ð£Ð´Ð°Ð»ÐµÐ½Ð°:** âœ… Ð£Ð”ÐÐ›Ð•ÐÐ

          ## âœ… Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
          Ð’Ð¡Ð Ð£Ð¡ÐŸÐ•Ð¨ÐÐž ÐžÐ§Ð˜Ð©Ð•ÐÐž
          """

          print(report)

          with open('CLEANUP_REPORT.md', 'w') as f:
              f.write(report)

          EOF
      - name: Generate failure report
        if: failure()
        run: |
          python3 << 'EOF'

          pr_number = "${{ github.event.pull_request.number }}"
          branch_name = "${{ github.event.pull_request.head.ref }}"

          report = f"""# âŒ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐÐ• ÐŸÐ ÐžÐ™Ð”Ð•ÐÐ

          ## âŒ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹:
            1. **PR ÐÐµ Ð—Ð°ÐºÑ€Ñ‹Ñ‚** - PR Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°ÐºÑ€Ñ‹Ñ‚ (merged Ð¸Ð»Ð¸ closed)
            2. **Ð’ÐµÑ‚ÐºÐ° ÐÐµ Ð£Ð´Ð°Ð»ÐµÐ½Ð°** - Ð’ÐµÑ‚ÐºÐ° '{branch_name}' Ð²ÑÑ‘ ÐµÑ‰Ñ‘ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            
          ## âŒ Ð§Ñ‚Ð¾ ÐÑƒÐ¶Ð½Ð¾ Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ:
            - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ PR Ð·Ð°ÐºÑ€Ñ‹Ñ‚
            - Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ Ð²ÐµÑ‚ÐºÑƒ: `git push origin --delete {branch_name}`
            - ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ PR ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
          ## âŒ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚

          ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐÐ• ÐŸÐ ÐžÐ™Ð”Ð•ÐÐ - WORKFLOW ÐŸÐÐ”ÐÐ•Ð¢ Ð¡ ÐžÐ¨Ð˜Ð‘ÐšÐžÐ™
          """

          print(report)

          with open('CLEANUP_REPORT.md', 'w') as f:
              f.write(report)

          EOF
      - name: Fail if checks didn't pass
        if: failure()
        run: |
          echo "âŒ WORKFLOW Ð£ÐŸÐÐ› Ð¡ ÐžÐ¨Ð˜Ð‘ÐšÐžÐ™"
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹:"
          echo "1. PR Ð½Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚ Ð˜Ð›Ð˜"
          echo "2. Ð’ÐµÑ‚ÐºÐ° Ð½Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
          exit 1
