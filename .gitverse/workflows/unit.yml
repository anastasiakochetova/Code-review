name: Check Code Quality

on:
  pull_request:
    branches: [ '**' ]

jobs:
  lint-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint
      
      - name: Check if assignment.py exists
        run: |
          if [ ! -f "assignment.py" ]; then
            echo "‚ùå –§–∞–π–ª assignment.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
      
      - name: Run flake8
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ flake8..."
          python -m flake8 assignment.py \
            --max-line-length=120 \
            --ignore=E501,W503 \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' \
            > flake8_report.txt 2>&1 || true
          
          if [ -s flake8_report.txt ]; then
            echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è flake8:"
            cat flake8_report.txt
          else
            echo "‚úÖ Flake8: OK"
          fi
      
      - name: Run pylint
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ pylint..."
          python -m pylint assignment.py \
            --disable=missing-module-docstring,missing-function-docstring \
            --disable=C0111 \
            --output-format=colorized \
            > pylint_report.txt 2>&1 || true
          
          if [ -s pylint_report.txt ]; then
            echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã pylint:"
            tail -n 10 pylint_report.txt
          fi
      
      - name: Create report
        run: |
          python3 << 'EOF'
          
          # –ß–∏—Ç–∞–µ–º flake8 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          try:
              with open('flake8_report.txt', 'r') as f:
                  flake8_issues = [line for line in f if line.strip()]
          except:
              flake8_issues = []
          
          # –ß–∏—Ç–∞–µ–º pylint —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          try:
              with open('pylint_report.txt', 'r') as f:
                  pylint_output = f.read()
                  # –ò—â–µ–º score
                  import re
                  match = re.search(r'Your code has been rated at ([\d.]+)', pylint_output)
                  pylint_score = match.group(1) if match else 'N/A'
          except:
              pylint_score = 'N/A'
          
          # –°–æ–∑–¥–∞—ë–º –æ—Ç—á—ë—Ç
          report = f"""# üìã –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê
          ## üîç Flake8
          - **–ù–∞—Ä—É—à–µ–Ω–∏–π:** {len(flake8_issues)}
          - **–°—Ç–∞—Ç—É—Å:** {'‚úÖ OK' if len(flake8_issues) == 0 else '‚ö†Ô∏è  –¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï'}
          
          ## üìä Pylint
          - **Score:** {pylint_score}/10
          - **–°—Ç–∞—Ç—É—Å:** {'‚úÖ OK' if pylint_score != 'N/A' and float(pylint_score) >= 8 else '‚ö†Ô∏è  –¢–†–ï–ë–£–ï–¢–°–Ø –î–û–†–ê–ë–û–¢–ö–ê'}
          
          ## üìà –ò—Ç–æ–≥–æ–≤–∞—è –û—Ü–µ–Ω–∫–∞
          {'‚úÖ –ö–û–î –ß–ò–°–¢–´–ô' if len(flake8_issues) == 0 and (pylint_score == 'N/A' or float(pylint_score) >= 8) else '‚ö†Ô∏è  –ù–£–ñ–ù–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø'}
          """
          
          with open('CODE_QUALITY.md', 'w') as f:
              f.write(report)
          
          print(report)
          
          EOF
      